language: rust
rust:
    - nightly
os: linux
dist: bionic
before_install:
    - sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
    - sudo adduser $USER libvirt
    - sudo adduser $USER kvm
    - cargo install cargo-download
    - rustup component add rust-src
    - rustup component add llvm-tools-preview
    - cargo install uhyve
script:
    - >
        if [ $(egrep -c '(vmx|svm)' /proc/cpuinfo) -eq "0" ]; then
            echo "No virtualization possible - uhyve can't run";
            exit -1;
        fi
    - cargo build -Z build-std=std,core,alloc,panic_abort --target x86_64-unknown-hermit
    - groups
    - ls -l /dev/kvm
    - sudo ls -la /var/run/libvirt/libvirt-sock
    # used to get terminal with new groups permissions while preserving own user
    - sudo -E sudo -u $USER -E bash -c "uhyve target/x86_64-unknown-hermit/debug/rusty_demo"